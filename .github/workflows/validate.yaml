name: Validate

on:
  pull_request:
    branches:
      - '*'

env:
  GO_VERSION: '1.25'
  GOLANGCI_LINT_VERSION: v2.5.0
  MISSPELL_VERSION: v0.6.0

jobs:
  lint:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: golangci-lint
        uses: golangci/golangci-lint-action@v8
        with:
          version: '${{ env.GOLANGCI_LINT_VERSION }}'

  validate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Install misspell ${{ env.MISSPELL_VERSION }}
        run: curl -sfL https://raw.githubusercontent.com/golangci/misspell/HEAD/install-misspell.sh | sh -s -- -b $(go env GOPATH)/bin ${MISSPELL_VERSION}

      - name: Validate
        run: make validate-files

  validate-generate:
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: go mod tidy
        run: |
          go mod tidy
          git diff --exit-code

  fingerprint-db-validation:
    name: Validate Fingerprint Database
    runs-on: ubuntu-latest

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Set up Go ${{ env.GO_VERSION }}
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          check-latest: true

      - name: Build vulntor CLI
        run: go build -o dist/vulntor ./cmd

      - name: Validate fingerprint_db.yaml
        run: ./dist/vulntor fingerprint validate pkg/fingerprint/data/fingerprint_db.yaml

  error-handling:
    name: Error Handling Standards (${{ matrix.target }})
    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        include:
          # Plugin commands (REQUIRED - enforced)
          - target: plugin
            path: cmd/vulntor/commands/plugin
            pattern: 'return\s+formatter\.PrintError\s*\('
            suggestion: 'Use formatter.PrintTotalFailureSummary(operation, err, plugin.ErrorCode(err))'
            required: true

          # Future targets (NOT YET ENFORCED - will be enabled as standards are defined)
          # - target: scan
          #   path: cmd/vulntor/commands/scan
          #   pattern: 'return\s+formatter\.PrintError\s*\('
          #   suggestion: 'Use standardized error wrapper (TBD)'
          #   required: false
          #
          # - target: storage
          #   path: cmd/vulntor/commands/storage
          #   pattern: 'return\s+formatter\.PrintError\s*\('
          #   suggestion: 'Use standardized error wrapper (TBD)'
          #   required: false
          #
          # - target: server
          #   path: cmd/vulntor/commands/server
          #   pattern: 'return\s+formatter\.PrintError\s*\('
          #   suggestion: 'Use standardized error wrapper (TBD)'
          #   required: false

    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Install ripgrep
        run: |
          curl -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.0/ripgrep_14.1.0-1_amd64.deb
          sudo dpkg -i ripgrep_14.1.0-1_amd64.deb

      - name: Check error handling patterns
        run: |
          chmod +x .github/scripts/check-error-handling.sh
          .github/scripts/check-error-handling.sh \
            "${{ matrix.path }}" \
            "${{ matrix.pattern }}" \
            "${{ matrix.suggestion }}"

      - name: Report non-required violations
        if: failure() && matrix.required == false
        run: |
          echo "::warning::Error handling violations found in ${{ matrix.target }}, but not yet enforced"
          exit 0
